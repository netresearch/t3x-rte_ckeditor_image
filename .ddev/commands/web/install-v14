#!/bin/bash

## Description: Install TYPO3 14.0 with your extension
## Usage: install-v14
## Example: ddev install-v14

VERSION=v14

# Test image dimensions for E2E tests
TEST_IMAGE_WIDTH=800
TEST_IMAGE_HEIGHT=600

rm -rf /var/www/html/$VERSION/*
mkdir -p /var/www/html/$VERSION/
echo "{}" > /var/www/html/$VERSION/composer.json
composer config extra.typo3/cms.web-dir public -d /var/www/html/$VERSION
composer config repositories.$EXTENSION_KEY path ../../$EXTENSION_KEY -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/cms-composer-installers true -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/class-alias-loader true -d /var/www/html/$VERSION
# Note: t3/cms metapackage doesn't have v14 yet, so install components separately
# First install the extension with TYPO3 core requirements
composer req $PACKAGE_NAME:'*@dev' --no-progress -n -d /var/www/html/$VERSION
composer req typo3/cms-extensionmanager typo3/cms-dashboard typo3/cms-reports --no-progress -n -d /var/www/html/$VERSION
composer req --dev typo3/cms-styleguide bk2k/bootstrap-package:'^16.0' --no-progress -n -d /var/www/html/$VERSION

cd /var/www/html/$VERSION

# MySQL credentials use environment variables with DDEV defaults
# Using MYSQL_PWD avoids exposing password in process list
DB_HOST="${MYSQL_HOST:-db}"
DB_USER="${MYSQL_USER:-root}"
export MYSQL_PWD="${MYSQL_PASSWORD:-root}"
mysql -h "$DB_HOST" -u "$DB_USER" -e "DROP DATABASE IF EXISTS ${VERSION};"
mysql -h "$DB_HOST" -u "$DB_USER" -e "CREATE DATABASE ${VERSION};"

vendor/bin/typo3 setup -n --dbname=$VERSION --password=$TYPO3_DB_PASSWORD --create-site="https://${VERSION}.rte-ckeditor-image.ddev.site" --admin-user-password=$TYPO3_SETUP_ADMIN_PASSWORD

# TYPO3 v14 removed the configuration:set command - write settings directly to additional.php
mkdir -p /var/www/html/$VERSION/config/system
cat > /var/www/html/$VERSION/config/system/additional.php << 'ADDPHP'
<?php
// Development settings
$GLOBALS['TYPO3_CONF_VARS']['BE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['FE']['debug'] = true;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['devIPmask'] = '*';
$GLOBALS['TYPO3_CONF_VARS']['SYS']['displayErrors'] = 1;
$GLOBALS['TYPO3_CONF_VARS']['SYS']['trustedHostsPattern'] = '.*';

// Mail settings (DDEV mailpit)
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['transport'] = 'smtp';
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['transport_smtp_server'] = 'localhost:1025';
$GLOBALS['TYPO3_CONF_VARS']['MAIL']['defaultMailFromAddress'] = 'admin@example.com';

// Graphics
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor'] = 'ImageMagick';
$GLOBALS['TYPO3_CONF_VARS']['GFX']['processor_path'] = '/usr/bin/';
ADDPHP

vendor/bin/typo3 extension:setup

# TYPO3 v14 setup creates a setup.typoscript with minimal PAGE definition.
# Remove it - site sets handle TypoScript loading automatically via config.yaml dependencies.
rm -f config/sites/main/setup.typoscript

# Create settings.yaml for site-specific configuration (logo, theme, etc.)
# TYPO3 v14 uses site sets - constants are configured via settings.yaml, not sys_template
cat > config/sites/main/settings.yaml << 'SETTINGSEOF'
# Site-specific settings for Bootstrap Package
# These override the defaults from bootstrap-package/full site set

# Logo configuration - using Netresearch branded demo logo
page.logo.file: 'fileadmin/user_upload/netresearch-logo.svg'
page.logo.fileInverted: 'fileadmin/user_upload/netresearch-logo.svg'
page.logo.height: 50
page.logo.width: 380
page.logo.alt: 'RTE CKEditor Image Demo'

# Theme settings
page.theme.navigation.style: 'default'
page.theme.breadcrumb.enable: 0

# Lightbox settings for click-to-enlarge compatibility
lib.contentElement.settings.media.popup.linkClass: 'lightbox'
lib.contentElement.settings.media.popup.directImageLink: 1
SETTINGSEOF

# Generate styleguide demo content for E2E tests
# This creates pages with various content elements including images
vendor/bin/typo3 styleguide:generate

# Add test content to homepage for E2E tests
# The styleguide creates demo content, but E2E tests need content on the root page
# Add a text content element with an image in the bodytext

# Create test images (needed before FAL registration)
mkdir -p public/fileadmin/user_upload

# Create Netresearch logo SVG with "RTE CKEditor Image Demo" text for header
cat > public/fileadmin/user_upload/netresearch-logo.svg << 'LOGOEOF'
<?xml version="1.0" encoding="UTF-8"?>
<svg viewBox="0 0 380 50" xmlns="http://www.w3.org/2000/svg">
  <title>RTE CKEditor Image Demo</title>
  <!-- Netresearch [n] symbol scaled to 50px height -->
  <g transform="scale(0.167) translate(0, 0)">
    <path fill="#2999a4" d="M209.6,0V31.62h32.77a26.38,26.38,0,0,1,26.44,26.43V242a26.38,26.38,0,0,1-26.44,26.44H209.6V300h47.93a42.77,42.77,0,0,0,42.86-42.86V42.89A42.76,42.76,0,0,0,257.53,0ZM43.25,0A42.76,42.76,0,0,0,.39,42.89V257.18A42.76,42.76,0,0,0,43.25,300H91.18V268.46H58.4A26.38,26.38,0,0,1,32,242v-184A26.37,26.37,0,0,1,58.4,31.62H91.18V0Z" transform="translate(-0.39 -0.04)"/>
    <path fill="#595a62" d="M221.44,120.41c0-34.48-13.94-57.82-48.93-57.82-26.62,0-48.54,7.74-64.17,26.56l-.7-22.06-28.31.06V232.94h31.59V124.69c7.14-18.38,32.14-34.8,53-34.5,27.38.4,25.2,26.24,26,45.81v96.94h31.58" transform="translate(-0.39 -0.04)"/>
  </g>
  <!-- "RTE CKEditor Image Demo" text -->
  <text x="60" y="32" font-family="system-ui, -apple-system, sans-serif" font-size="18" font-weight="600" fill="#2F99A4">RTE CKEditor Image Demo</text>
</svg>
LOGOEOF

# Create branded demo images using Netresearch and TYPO3 colors
# NR Teal: #2F99A4, NR Orange: #FF4D00, TYPO3 Orange: #FF8700
if command -v convert &> /dev/null; then
    # Main block image - TYPO3 branded (orange gradient)
    convert -size ${TEST_IMAGE_WIDTH}x${TEST_IMAGE_HEIGHT} \
        -define gradient:angle=135 \
        gradient:'#FF8700'-'#FF4D00' \
        -pointsize 72 \
        -fill white -gravity center \
        -annotate +0-50 'TYPO3' \
        -pointsize 24 \
        -annotate +0+50 'Click to Enlarge Demo' \
        public/fileadmin/user_upload/example.jpg

    # Small inline image - Netresearch branded (teal with [n] logo)
    convert -size 100x75 \
        xc:'#2F99A4' \
        -pointsize 28 \
        -fill white -gravity center \
        -annotate +0+0 '[n]' \
        public/fileadmin/user_upload/inline-small.jpg

    # Medium image - Netresearch teal gradient
    convert -size 400x300 \
        -define gradient:angle=45 \
        gradient:'#2F99A4'-'#1a5a5f' \
        -pointsize 36 \
        -fill white -gravity center \
        -annotate +0-30 'Netresearch' \
        -pointsize 18 \
        -annotate +0+30 'Image Demo' \
        public/fileadmin/user_upload/medium.jpg

    # Icon-sized image - NR Orange with [n]
    convert -size 32x32 \
        xc:'#FF4D00' \
        -pointsize 16 \
        -fill white -gravity center \
        -annotate +0+0 '[n]' \
        public/fileadmin/user_upload/icon.jpg
else
    echo "Warning: ImageMagick not found, creating minimal placeholder images"
    # Create minimal JPEG for each
    echo '/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAABAAEDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9/KKKKAP/2Q==' | base64 -d > public/fileadmin/user_upload/example.jpg
    cp public/fileadmin/user_upload/example.jpg public/fileadmin/user_upload/inline-small.jpg
    cp public/fileadmin/user_upload/example.jpg public/fileadmin/user_upload/medium.jpg
    cp public/fileadmin/user_upload/example.jpg public/fileadmin/user_upload/icon.jpg
fi

# Get actual file info for FAL entries
get_file_info() {
    local file=$1
    local size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
    local sha1=$(sha1sum "$file" 2>/dev/null | cut -d' ' -f1 || shasum "$file" | cut -d' ' -f1)
    echo "$size $sha1"
}

FILE1_INFO=($(get_file_info "public/fileadmin/user_upload/example.jpg"))
FILE2_INFO=($(get_file_info "public/fileadmin/user_upload/inline-small.jpg"))
FILE3_INFO=($(get_file_info "public/fileadmin/user_upload/medium.jpg"))
FILE4_INFO=($(get_file_info "public/fileadmin/user_upload/icon.jpg"))

# Create FAL entries and demo content
mysql -h "$DB_HOST" -u "$DB_USER" "$VERSION" << EOSQL
-- =============================================================================
-- FILE 1: example.jpg (800x600, main block image)
-- =============================================================================
INSERT INTO sys_file (pid, storage, type, identifier, identifier_hash, folder_hash, extension, mime_type, name, sha1, size, creation_date, modification_date, tstamp, last_indexed)
VALUES (0, 1, 2, '/user_upload/example.jpg', SHA1('/user_upload/example.jpg'), SHA1('/user_upload'), 'jpg', 'image/jpeg', 'example.jpg', '${FILE1_INFO[1]}', ${FILE1_INFO[0]}, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
SET @file1_uid = LAST_INSERT_ID();
INSERT INTO sys_file_metadata (pid, tstamp, crdate, file, width, height) VALUES (0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), @file1_uid, 800, 600);

-- =============================================================================
-- FILE 2: inline-small.jpg (100x75, for inline demos)
-- =============================================================================
INSERT INTO sys_file (pid, storage, type, identifier, identifier_hash, folder_hash, extension, mime_type, name, sha1, size, creation_date, modification_date, tstamp, last_indexed)
VALUES (0, 1, 2, '/user_upload/inline-small.jpg', SHA1('/user_upload/inline-small.jpg'), SHA1('/user_upload'), 'jpg', 'image/jpeg', 'inline-small.jpg', '${FILE2_INFO[1]}', ${FILE2_INFO[0]}, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
SET @file2_uid = LAST_INSERT_ID();
INSERT INTO sys_file_metadata (pid, tstamp, crdate, file, width, height) VALUES (0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), @file2_uid, 100, 75);

-- =============================================================================
-- FILE 3: medium.jpg (400x300, for various demos)
-- =============================================================================
INSERT INTO sys_file (pid, storage, type, identifier, identifier_hash, folder_hash, extension, mime_type, name, sha1, size, creation_date, modification_date, tstamp, last_indexed)
VALUES (0, 1, 2, '/user_upload/medium.jpg', SHA1('/user_upload/medium.jpg'), SHA1('/user_upload'), 'jpg', 'image/jpeg', 'medium.jpg', '${FILE3_INFO[1]}', ${FILE3_INFO[0]}, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
SET @file3_uid = LAST_INSERT_ID();
INSERT INTO sys_file_metadata (pid, tstamp, crdate, file, width, height) VALUES (0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), @file3_uid, 400, 300);

-- =============================================================================
-- FILE 4: icon.jpg (32x32, for icon-sized inline demos)
-- =============================================================================
INSERT INTO sys_file (pid, storage, type, identifier, identifier_hash, folder_hash, extension, mime_type, name, sha1, size, creation_date, modification_date, tstamp, last_indexed)
VALUES (0, 1, 2, '/user_upload/icon.jpg', SHA1('/user_upload/icon.jpg'), SHA1('/user_upload'), 'jpg', 'image/jpeg', 'icon.jpg', '${FILE4_INFO[1]}', ${FILE4_INFO[0]}, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), UNIX_TIMESTAMP());
SET @file4_uid = LAST_INSERT_ID();
INSERT INTO sys_file_metadata (pid, tstamp, crdate, file, width, height) VALUES (0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), @file4_uid, 32, 32);

-- =============================================================================
-- Update sys_template to use Bootstrap Package layout + rte_ckeditor_image
-- Configure lightbox class for Bootstrap Package compatibility (PhotoSwipe)
-- =============================================================================
UPDATE sys_template SET
    include_static_file = 'EXT:bootstrap_package/Configuration/TypoScript/,EXT:bootstrap_package/Configuration/TypoScript/ContentElement/,EXT:fluid_styled_content/Configuration/TypoScript/,EXT:rte_ckeditor_image/Configuration/TypoScript/',
    config = 'lib.contentElement.settings.media.popup.linkClass = lightbox
lib.contentElement.settings.media.popup.directImageLink = 1
lib.contentElement.settings.media.popup.linkParams.ATagParams = rel="lightbox-group-rte"'
WHERE uid = 1;

-- =============================================================================
-- Update page title for better presentation
-- NOTE: In TYPO3 v14, sys_template is NOT used with site sets.
-- TypoScript is loaded via site set dependencies in config.yaml.
-- Settings (constants) are configured via settings.yaml in the site folder.
-- =============================================================================
UPDATE pages SET title = 'RTE CKEditor Image Demo' WHERE uid = 1;

-- =============================================================================
-- CONTENT ELEMENT 1: Hero Introduction with Feature Cards
-- =============================================================================
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (1, 'text', '',
'<div class="container py-4">
<div class="text-center mb-5">
<h1 class="display-5 fw-bold" style="color: #2F99A4;">RTE CKEditor Image</h1>
<p class="lead text-muted">Advanced image handling for CKEditor 5 in TYPO3</p>
</div>
<div class="row g-4 mb-5">
<div class="col-md-6 col-lg-3">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body text-center">
<div class="display-6 mb-3" style="color: #FF4D00;">&#128444;</div>
<h5 class="card-title">Block Images</h5>
<p class="card-text small text-muted">Standalone images with captions and alignment options</p>
</div>
</div>
</div>
<div class="col-md-6 col-lg-3">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body text-center">
<div class="display-6 mb-3" style="color: #2F99A4;">&#128196;</div>
<h5 class="card-title">Inline Images</h5>
<p class="card-text small text-muted">Images that flow naturally with text content</p>
</div>
</div>
</div>
<div class="col-md-6 col-lg-3">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body text-center">
<div class="display-6 mb-3" style="color: #FF8700;">&#128269;</div>
<h5 class="card-title">Click-to-Enlarge</h5>
<p class="card-text small text-muted">Lightbox functionality for image previews</p>
</div>
</div>
</div>
<div class="col-md-6 col-lg-3">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body text-center">
<div class="display-6 mb-3" style="color: #585961;">&#128279;</div>
<h5 class="card-title">Image Links</h5>
<p class="card-text small text-muted">Wrap images in links to pages, files, or URLs</p>
</div>
</div>
</div>
</div>
</div>',
0, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 100);

-- =============================================================================
-- CONTENT ELEMENT 2: Block Images Demo Card
-- =============================================================================
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (1, 'text', '',
CONCAT(
'<div class="card mb-4 border-0 shadow">
<div class="card-header py-3" style="background: linear-gradient(135deg, #FF8700, #FF4D00); color: white;">
<h3 class="mb-0">Block Images with Click-to-Enlarge</h3>
</div>
<div class="card-body">
<div class="row">
<div class="col-lg-6">
<figure class="image text-center">
<img src="fileadmin/user_upload/example.jpg" alt="Block image example" width="400" height="300" data-htmlarea-file-uid="', @file1_uid, '" data-htmlarea-file-table="sys_file" data-htmlarea-zoom="true" data-title-override="true" data-alt-override="true" class="img-fluid rounded shadow-sm">
<figcaption class="mt-2 text-muted small">Click the image to test the lightbox</figcaption>
</figure>
</div>
<div class="col-lg-6">
<h5>How it works</h5>
<p>Block images are standalone elements with optional captions. The <code>data-htmlarea-zoom="true"</code> attribute enables the lightbox.</p>
<div class="alert alert-info small mb-0">
<strong>Try it:</strong> Click the image to see the lightbox popup in action.
</div>
</div>
</div>
</div>
</div>'
),
0, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 200);

-- =============================================================================
-- CONTENT ELEMENT 3: Inline Images Demo Card (IMPORTANT FOR E2E TESTS)
-- =============================================================================
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (1, 'text', '',
CONCAT(
'<div class="card mb-4 border-0 shadow">
<div class="card-header py-3" style="background: linear-gradient(135deg, #2F99A4, #1a5a5f); color: white;">
<h3 class="mb-0">Inline Images</h3>
</div>
<div class="card-body">
<p class="lead">Inline images flow naturally with your text content:</p>
<div class="bg-light p-3 rounded mb-3">
<p class="mb-2">This text has an <img class="image image-inline" src="fileadmin/user_upload/inline-small.jpg" alt="inline example" width="50" height="38" data-htmlarea-file-uid="', @file2_uid, '" data-htmlarea-file-table="sys_file" data-title-override="true" data-alt-override="true"> inline image embedded in the middle of the sentence, and the text continues after it.</p>
<p class="mb-0">You can also use icon-sized images <img class="image image-inline" src="fileadmin/user_upload/icon.jpg" alt="icon" width="20" height="20" data-htmlarea-file-uid="', @file4_uid, '" data-htmlarea-file-table="sys_file" data-title-override="true" data-alt-override="true"> like this one as visual markers in your content.</p>
</div>
<div class="row">
<div class="col-md-6">
<div class="alert alert-success small mb-0">
<strong>Key difference:</strong> Inline images use <code>class="image image-inline"</code> and render as plain <code>&lt;img&gt;</code> tags.
</div>
</div>
<div class="col-md-6">
<div class="alert alert-warning small mb-0">
<strong>E2E tested:</strong> This content is used by our Playwright tests.
</div>
</div>
</div>
</div>
</div>'
),
0, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 300);

-- =============================================================================
-- CONTENT ELEMENT 4: More Inline Examples (Clickable + Multiple)
-- =============================================================================
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (1, 'text', '',
CONCAT(
'<div class="row g-4 mb-4">
<div class="col-md-6">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body">
<h5 class="card-title" style="color: #2F99A4;">Inline + Click-to-Enlarge</h5>
<p>Inline images can also have lightbox enabled. Click this: <img class="image image-inline" src="fileadmin/user_upload/inline-small.jpg" alt="clickable inline" width="50" height="38" data-htmlarea-file-uid="', @file2_uid, '" data-htmlarea-file-table="sys_file" data-htmlarea-zoom="true" data-title-override="true" data-alt-override="true"> to see it work.</p>
<p class="small text-muted mb-0">Just add <code>data-htmlarea-zoom="true"</code></p>
</div>
</div>
</div>
<div class="col-md-6">
<div class="card h-100 border-0 shadow-sm">
<div class="card-body">
<h5 class="card-title" style="color: #FF4D00;">Multiple Inline Images</h5>
<p>Multiple images in one paragraph: <img class="image image-inline" src="fileadmin/user_upload/icon.jpg" alt="icon 1" width="24" height="24" data-htmlarea-file-uid="', @file4_uid, '" data-htmlarea-file-table="sys_file"> first <img class="image image-inline" src="fileadmin/user_upload/icon.jpg" alt="icon 2" width="24" height="24" data-htmlarea-file-uid="', @file4_uid, '" data-htmlarea-file-table="sys_file"> second <img class="image image-inline" src="fileadmin/user_upload/icon.jpg" alt="icon 3" width="24" height="24" data-htmlarea-file-uid="', @file4_uid, '" data-htmlarea-file-table="sys_file"> third</p>
<p class="small text-muted mb-0">All flow naturally with the text</p>
</div>
</div>
</div>
</div>'
),
0, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 400);

-- =============================================================================
-- CONTENT ELEMENT 5: Image Alignment Demo
-- =============================================================================
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (1, 'text', '',
CONCAT(
'<div class="card mb-4 border-0 shadow">
<div class="card-header py-3" style="background: #585961; color: white;">
<h3 class="mb-0">Image Alignment</h3>
</div>
<div class="card-body">
<p>Block images support <code>image-left</code>, <code>image-center</code>, and <code>image-right</code> alignment classes:</p>
<div class="row">
<div class="col-lg-6 mb-3">
<div class="border rounded p-3">
<figure class="image image-left mb-0">
<img src="fileadmin/user_upload/medium.jpg" alt="left aligned" width="150" height="113" data-htmlarea-file-uid="', @file3_uid, '" data-htmlarea-file-table="sys_file" class="rounded">
</figure>
<p class="small">Text flows around the left-aligned image. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt.</p>
<div style="clear:both"></div>
</div>
</div>
<div class="col-lg-6 mb-3">
<div class="border rounded p-3 text-center">
<figure class="image image-center">
<img src="fileadmin/user_upload/medium.jpg" alt="center aligned" width="150" height="113" data-htmlarea-file-uid="', @file3_uid, '" data-htmlarea-file-table="sys_file" class="rounded">
</figure>
<p class="small mb-0">Center-aligned images are displayed in the middle</p>
</div>
</div>
</div>
</div>
</div>'
),
0, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 500);

-- =============================================================================
-- CONTENT ELEMENT 6: Images with Links Demo
-- =============================================================================
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (1, 'text', '',
CONCAT(
'<div class="card mb-4 border-0 shadow">
<div class="card-header py-3" style="background: linear-gradient(135deg, #FF4D00, #FF8700); color: white;">
<h3 class="mb-0">Images with Links</h3>
</div>
<div class="card-body">
<div class="row align-items-center">
<div class="col-md-4 text-center mb-3 mb-md-0">
<figure class="image">
<a href="https://typo3.org" target="_blank" title="Visit TYPO3.org">
<img src="fileadmin/user_upload/medium.jpg" alt="linked image" width="200" height="150" data-htmlarea-file-uid="', @file3_uid, '" data-htmlarea-file-table="sys_file" class="rounded shadow-sm">
</a>
<figcaption class="small text-muted mt-2">Click to visit TYPO3.org</figcaption>
</figure>
</div>
<div class="col-md-8">
<h5>Block Image Link</h5>
<p>Images can be wrapped in links to external URLs, internal pages, or files. The link is set via the image edit dialog in CKEditor.</p>
<hr>
<h5>Inline Image Link</h5>
<p>Here is a linked inline image: <a href="https://github.com/netresearch/t3x-rte_ckeditor_image" target="_blank" class="text-decoration-none"><img class="image image-inline" src="fileadmin/user_upload/icon.jpg" alt="GitHub" width="24" height="24" data-htmlarea-file-uid="', @file4_uid, '" data-htmlarea-file-table="sys_file"></a> linking to our GitHub repository.</p>
</div>
</div>
</div>
</div>'
),
0, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 600);

-- =============================================================================
-- CONTENT ELEMENT 7: Testing Instructions Card
-- =============================================================================
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (1, 'text', '',
'<div class="card border-0 shadow" style="border-left: 4px solid #2F99A4 !important;">
<div class="card-body">
<h3 class="card-title" style="color: #2F99A4;">Test the Extension</h3>
<div class="row">
<div class="col-md-6">
<ol class="mb-0">
<li>Log in to the <a href="/typo3/" class="fw-bold">TYPO3 Backend</a></li>
<li>Go to <strong>Page â†’ Edit content</strong></li>
<li>Click any content element to edit</li>
<li>In the RTE, try:
<ul class="mt-2">
<li>Insert images via toolbar button</li>
<li>Double-click images to edit properties</li>
<li>Toggle block/inline mode</li>
<li>Add/remove click-to-enlarge</li>
<li>Add links to images</li>
</ul>
</li>
<li>Save and check frontend rendering</li>
</ol>
</div>
<div class="col-md-6">
<div class="bg-light rounded p-3">
<h6 class="text-muted">Backend Credentials</h6>
<p class="mb-1"><strong>User:</strong> <code>admin</code></p>
<p class="mb-0"><strong>Password:</strong> <code>Joh316!!</code></p>
</div>
</div>
</div>
</div>
</div>',
0, 0, UNIX_TIMESTAMP(), UNIX_TIMESTAMP(), 0, 700);

EOSQL

# Add site sets to site configuration (TYPO3 v13 approach)
# Bootstrap Package is added for frontend rendering demo
# rte_ckeditor_image site set is added for frontend TypoScript
if [ -f config/sites/main/config.yaml ]; then
    # Safely update dependencies using PHP YAML parsing to avoid corrupting other sections
    php -r "
        \$file = 'config/sites/main/config.yaml';
        \$yaml = yaml_parse_file(\$file);
        \$yaml['dependencies'] = ['bootstrap-package/full', 'netresearch/rte-ckeditor-image'];
        file_put_contents(\$file, yaml_emit(\$yaml, YAML_UTF8_ENCODING));
    " 2>/dev/null || {
        # Fallback: append if PHP yaml extension not available
        # Check if our specific dependency is missing (handles both missing key and partial entries)
        if ! grep -q 'netresearch/rte-ckeditor-image' config/sites/main/config.yaml; then
            if ! grep -q '^dependencies:' config/sites/main/config.yaml; then
                echo "dependencies:" >> config/sites/main/config.yaml
            fi
            if ! grep -q 'bootstrap-package/full' config/sites/main/config.yaml; then
                echo "  - bootstrap-package/full" >> config/sites/main/config.yaml
            fi
            echo "  - netresearch/rte-ckeditor-image" >> config/sites/main/config.yaml
        fi
    }
fi

vendor/bin/typo3 cache:flush

echo ""
echo "TYPO3 $VERSION installation complete!"
echo ""
echo "rte_ckeditor_image configuration:"
echo "- Backend RTE: auto-configured (insertimage button available)"
echo "- Frontend TypoScript: included via site set dependency"
echo "- Test content with images added to homepage for E2E testing"
echo ""
echo "Test click-to-enlarge: https://${VERSION}.rte-ckeditor-image.ddev.site/"
