#!/bin/bash

## Description: Install TYPO3 13.4 LTS with your extension
## Usage: install-v13
## Example: ddev install-v13

VERSION=v13

rm -rf /var/www/html/$VERSION/*
mkdir -p /var/www/html/$VERSION/
echo "{}" > /var/www/html/$VERSION/composer.json
composer config extra.typo3/cms.web-dir public -d /var/www/html/$VERSION
composer config repositories.$EXTENSION_KEY path ../../$EXTENSION_KEY -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/cms-composer-installers true -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/class-alias-loader true -d /var/www/html/$VERSION
composer req t3/cms:'^13' $PACKAGE_NAME:'*@dev' --no-progress -n -d /var/www/html/$VERSION
composer req typo3/cms-extensionmanager typo3/cms-dashboard typo3/cms-reports --no-progress -n -d /var/www/html/$VERSION
composer req --dev typo3/cms-styleguide bk2k/bootstrap-package:'^15.0' --no-progress -n -d /var/www/html/$VERSION

cd /var/www/html/$VERSION

mysql -h db -u root -p"root" -e "DROP DATABASE IF EXISTS ${VERSION};"
mysql -h db -u root -p"root" -e "CREATE DATABASE ${VERSION};"

vendor/bin/typo3 setup -n --dbname=$VERSION --password=$TYPO3_DB_PASSWORD --create-site="https://${VERSION}.rte-ckeditor-image.ddev.site" --admin-user-password=$TYPO3_SETUP_ADMIN_PASSWORD

vendor/bin/typo3 configuration:set 'BE/debug' 1
vendor/bin/typo3 configuration:set 'FE/debug' 1
vendor/bin/typo3 configuration:set 'SYS/devIPmask' '*'
vendor/bin/typo3 configuration:set 'SYS/displayErrors' 1
# Create additional.php for trustedHostsPattern (configuration:set doesn't work reliably for this)
mkdir -p /var/www/html/$VERSION/config/system
echo '<?php' > /var/www/html/$VERSION/config/system/additional.php
echo '$GLOBALS["TYPO3_CONF_VARS"]["SYS"]["trustedHostsPattern"] = ".*";' >> /var/www/html/$VERSION/config/system/additional.php
vendor/bin/typo3 configuration:set 'MAIL/transport' 'smtp'
vendor/bin/typo3 configuration:set 'MAIL/transport_smtp_server' 'localhost:1025'
vendor/bin/typo3 configuration:set 'MAIL/defaultMailFromAddress' 'admin@example.com'
vendor/bin/typo3 configuration:set 'GFX/processor' 'ImageMagick'
vendor/bin/typo3 configuration:set 'GFX/processor_path' '/usr/bin/'

sed -i "/'deprecations'/,/^[[:space:]]*'disabled' => true,/s/'disabled' => true,/'disabled' => false,/" /var/www/html/$VERSION/config/system/settings.php

vendor/bin/typo3 extension:setup

# Add site sets to site configuration (TYPO3 v13 approach)
# This configures Bootstrap Package + rte_ckeditor_image via site sets instead of static templates
if [ -f config/sites/main/config.yaml ]; then
    # Remove any existing dependencies section
    sed -i '/^dependencies:/d' config/sites/main/config.yaml
    sed -i '/^  - /d' config/sites/main/config.yaml

    # Add dependencies section with both Bootstrap Package and rte_ckeditor_image
    echo "dependencies:" >> config/sites/main/config.yaml
    echo "  - bootstrap-package/full" >> config/sites/main/config.yaml
    echo "  - netresearch/rte-ckeditor-image" >> config/sites/main/config.yaml
fi

vendor/bin/typo3 cache:flush

echo ""
echo "‚úÖ TYPO3 $VERSION installation complete!"
echo "üé® rte_ckeditor_image is auto-configured (zero-configuration installation)"
echo "üìê TYPO3 Styleguide is available for UI pattern reference"
echo "üñºÔ∏è  Site set included - click-to-enlarge functionality enabled"
echo "üéÅ Bootstrap Package installed for frontend rendering"
echo "üîç Test click-to-enlarge: https://${VERSION}.rte-ckeditor-image.ddev.site/"
