name: Create Release

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Version to release (e.g., 13.3.2)'
                required: true
                type: string
            release_notes:
                description: 'Release notes (markdown supported)'
                required: false
                type: string
                default: ''

permissions:
    contents: read

jobs:
    create-release:
        name: Create Release
        runs-on: ubuntu-latest

        permissions:
            contents: write

        env:
            INPUT_VERSION: ${{ inputs.version }}
            INPUT_RELEASE_NOTES: ${{ inputs.release_notes }}

        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
              with:
                  egress-policy: audit

            - name: Validate version format
              run: |
                  if ! [[ "${INPUT_VERSION}" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
                      echo "::error::Invalid version format: ${INPUT_VERSION}. Expected: X.Y.Z (e.g., 13.3.2)"
                      exit 1
                  fi
                  echo "VERSION=${INPUT_VERSION}" >> $GITHUB_ENV

            - name: Checkout repository
              uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Update ext_emconf.php version and commit
              run: |
                  # Check current version before modifying
                  CURRENT_VERSION=$(grep -oP "'version'\s*=>\s*'\K[^']+" ext_emconf.php)
                  echo "Current version: ${CURRENT_VERSION}"
                  echo "Target version: ${VERSION}"

                  if [[ "${CURRENT_VERSION}" == "${VERSION}" ]]; then
                      echo "::notice::ext_emconf.php already at version ${VERSION}, skipping update"
                  else
                      sed -i "s/'version'[[:space:]]*=>[[:space:]]*'[^']*'/'version'        => '${VERSION}'/" ext_emconf.php
                      echo "Updated ext_emconf.php to version ${VERSION}"
                      grep "'version'" ext_emconf.php
                      git add ext_emconf.php
                      git commit -m "chore: bump version to ${VERSION}"
                      git push origin main
                  fi

            - name: Build verification footer
              run: |
                  cat > /tmp/verification-footer.md <<'EOF'

                  ---

                  ### Verifying this release

                  ```bash
                  # Verify the GPG signature on the release tag
                  git tag -v vVERSION_PLACEHOLDER

                  # Verify SLSA provenance (when assets are attached)
                  gh attestation verify <downloaded-file> \
                    --repo netresearch/t3x-rte_ckeditor_image
                  ```
                  EOF
                  sed -i "s/VERSION_PLACEHOLDER/${VERSION}/" /tmp/verification-footer.md

            - name: Create release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  if [[ -n "${INPUT_RELEASE_NOTES}" ]]; then
                      printf '%s' "${INPUT_RELEASE_NOTES}" > /tmp/release-notes.md
                      cat /tmp/verification-footer.md >> /tmp/release-notes.md
                      gh release create "v${VERSION}" \
                          --title "v${VERSION}" \
                          --notes-file /tmp/release-notes.md
                  else
                      gh release create "v${VERSION}" \
                          --title "v${VERSION}" \
                          --generate-notes
                      # Append verification footer to auto-generated notes
                      gh release view "v${VERSION}" --json body --jq '.body // ""' > /tmp/release-notes.md
                      cat /tmp/verification-footer.md >> /tmp/release-notes.md
                      gh release edit "v${VERSION}" \
                          --notes-file /tmp/release-notes.md
                  fi

            - name: Output release URL
              run: |
                  echo "::notice::Release created: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
