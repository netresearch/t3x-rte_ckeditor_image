#!/bin/bash

## Description: Install TYPO3 13.4 LTS with your extension
## Usage: install-v13
## Example: ddev install-v13

VERSION=v13

# Test image dimensions for E2E tests
TEST_IMAGE_WIDTH=800
TEST_IMAGE_HEIGHT=600

rm -rf /var/www/html/$VERSION/*
mkdir -p /var/www/html/$VERSION/
echo "{}" > /var/www/html/$VERSION/composer.json
composer config extra.typo3/cms.web-dir public -d /var/www/html/$VERSION
composer config repositories.$EXTENSION_KEY path ../../$EXTENSION_KEY -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/cms-composer-installers true -d /var/www/html/$VERSION
composer config --no-plugins allow-plugins.typo3/class-alias-loader true -d /var/www/html/$VERSION
composer req t3/cms:'^13' $PACKAGE_NAME:'*@dev' --no-progress -n -d /var/www/html/$VERSION
composer req typo3/cms-extensionmanager typo3/cms-dashboard typo3/cms-reports --no-progress -n -d /var/www/html/$VERSION
composer req --dev typo3/cms-styleguide bk2k/bootstrap-package:'^15.0' --no-progress -n -d /var/www/html/$VERSION

cd /var/www/html/$VERSION

mysql -h db -u root -p"root" -e "DROP DATABASE IF EXISTS ${VERSION};"
mysql -h db -u root -p"root" -e "CREATE DATABASE ${VERSION};"

vendor/bin/typo3 setup -n --dbname=$VERSION --password=$TYPO3_DB_PASSWORD --create-site="https://${VERSION}.rte-ckeditor-image.ddev.site" --admin-user-password=$TYPO3_SETUP_ADMIN_PASSWORD

vendor/bin/typo3 configuration:set 'BE/debug' 1
vendor/bin/typo3 configuration:set 'FE/debug' 1
vendor/bin/typo3 configuration:set 'SYS/devIPmask' '*'
vendor/bin/typo3 configuration:set 'SYS/displayErrors' 1
# Create additional.php for trustedHostsPattern (configuration:set doesn't work reliably for this)
mkdir -p /var/www/html/$VERSION/config/system
echo '<?php' > /var/www/html/$VERSION/config/system/additional.php
echo '$GLOBALS["TYPO3_CONF_VARS"]["SYS"]["trustedHostsPattern"] = ".*";' >> /var/www/html/$VERSION/config/system/additional.php
vendor/bin/typo3 configuration:set 'MAIL/transport' 'smtp'
vendor/bin/typo3 configuration:set 'MAIL/transport_smtp_server' 'localhost:1025'
vendor/bin/typo3 configuration:set 'MAIL/defaultMailFromAddress' 'admin@example.com'
vendor/bin/typo3 configuration:set 'GFX/processor' 'ImageMagick'
vendor/bin/typo3 configuration:set 'GFX/processor_path' '/usr/bin/'

sed -i "/'deprecations'/,/^[[:space:]]*'disabled' => true,/s/'disabled' => true,/'disabled' => false,/" /var/www/html/$VERSION/config/system/settings.php

vendor/bin/typo3 extension:setup

# Generate styleguide demo content for E2E tests
# This creates pages with various content elements including images
vendor/bin/typo3 styleguide:generate

# Add test content to homepage for E2E tests
# The styleguide creates demo content, but E2E tests need content on the root page
# Add a text content element with an image in the bodytext
# NOTE: MySQL credentials are hardcoded for DDEV local development only
mysql -h db -u root -p"root" $VERSION << EOSQL
INSERT INTO tt_content (pid, CType, header, bodytext, hidden, deleted, tstamp, crdate, colPos, sorting)
VALUES (
    1,
    'text',
    'Welcome to RTE CKEditor Image Demo',
    '<p>This is a test page with an image:</p><p><img src="fileadmin/user_upload/example.jpg" alt="Example image" width="$TEST_IMAGE_WIDTH" height="$TEST_IMAGE_HEIGHT" /></p><p>Click the image to see the click-to-enlarge functionality.</p>',
    0,
    0,
    UNIX_TIMESTAMP(),
    UNIX_TIMESTAMP(),
    0,
    256
);
EOSQL

# Create a dummy image file for the test
mkdir -p public/fileadmin/user_upload
# Create a test image using ImageMagick (pre-installed in DDEV web container)
if command -v convert &> /dev/null; then
    convert -size ${TEST_IMAGE_WIDTH}x${TEST_IMAGE_HEIGHT} xc:blue -pointsize 48 -fill white -gravity center -annotate +0+0 'Test Image\nfor E2E Tests' public/fileadmin/user_upload/example.jpg
else
    echo "Warning: ImageMagick not found, creating placeholder image"
    # Fallback: Create a minimal valid JPEG if convert is not available
    echo -e "Warning: E2E tests may fail without a valid test image"
fi

# Add site sets to site configuration (TYPO3 v13 approach)
# Bootstrap Package is added for frontend rendering demo
# Note: rte_ckeditor_image uses an event listener for true zero-configuration,
# so adding it to dependencies is optional (but recommended for clarity)
if [ -f config/sites/main/config.yaml ]; then
    # Remove any existing dependencies section
    sed -i '/^dependencies:/d' config/sites/main/config.yaml
    sed -i '/^  - /d' config/sites/main/config.yaml

    # Add dependencies section with Bootstrap Package
    # rte_ckeditor_image uses AfterTemplatesHaveBeenDeterminedEvent for auto-injection
    echo "dependencies:" >> config/sites/main/config.yaml
    echo "  - bootstrap-package/full" >> config/sites/main/config.yaml
fi

vendor/bin/typo3 cache:flush

echo ""
echo "TYPO3 $VERSION installation complete!"
echo ""
echo "rte_ckeditor_image is auto-configured (true zero-configuration)"
echo "- TypoScript automatically injected via AfterTemplatesHaveBeenDeterminedEvent"
echo "- Works with Bootstrap Package without manual sys_template configuration"
echo "- Test content with images added to homepage for E2E testing"
echo ""
echo "Test click-to-enlarge: https://${VERSION}.rte-ckeditor-image.ddev.site/"
