#!/bin/bash

## Description: Capture git info for landing page before container build
## Usage: Runs automatically before ddev start
## Example: "ddev start"

# Get git info from host
GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
GIT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
GIT_PR=$(gh pr view --json number 2>/dev/null | jq -r '.number // "unknown"' 2>/dev/null || echo "unknown")

# Write docker-compose override with current git info
cat > .ddev/docker-compose.git-info.yaml << EOF
services:
  web:
    build:
      args:
        GIT_BRANCH: "${GIT_BRANCH}"
        GIT_COMMIT: "${GIT_COMMIT}"
        GIT_PR: "${GIT_PR}"
EOF

echo "Git info updated: ${GIT_BRANCH} @ ${GIT_COMMIT} (PR: ${GIT_PR})"
