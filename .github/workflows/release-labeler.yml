# Release Labeler Workflow
# Automatically labels PRs and issues with the release version they shipped in
#
# Features:
# - Creates `released:vX.Y.Z` label on release publish
# - Labels all PRs merged between previous and current release
# - Labels issues that were closed by those PRs
# - Adds comment linking to the release
#
# Usage:
# 1. Copy to .github/workflows/release-labeler.yml
# 2. Ensure GITHUB_TOKEN has issues:write and pull-requests:write permissions

name: Release Labeler

on:
  release:
    types: [published]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  label-release:
    name: Label PRs and Issues
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          RELEASE_URL: ${{ github.event.release.html_url }}
        run: |
          echo "tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "url=${RELEASE_URL}" >> $GITHUB_OUTPUT
          # Label format: released:v1.2.3
          echo "label=released:${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: Get previous release tag
        id: prev_release
        env:
          GH_TOKEN: ${{ github.token }}
          CURRENT_TAG: ${{ steps.release.outputs.tag }}
        run: |
          # Get the previous release tag (skip current)
          PREV_TAG=$(gh api repos/${{ github.repository }}/releases \
            --jq "[.[] | select(.tag_name != \"${CURRENT_TAG}\" and .prerelease == false)] | .[0].tag_name // \"\"")
          echo "tag=${PREV_TAG}" >> $GITHUB_OUTPUT
          echo "Previous release: ${PREV_TAG:-none}"

      - name: Create release label
        env:
          GH_TOKEN: ${{ github.token }}
          LABEL_NAME: ${{ steps.release.outputs.label }}
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
        run: |
          # Create or update label (green color: 0e8a16)
          gh label create "${LABEL_NAME}" \
            --repo ${{ github.repository }} \
            --color 0e8a16 \
            --description "Released in ${RELEASE_TAG}" \
            --force

      - name: Find and label merged PRs
        id: label_prs
        env:
          GH_TOKEN: ${{ github.token }}
          LABEL_NAME: ${{ steps.release.outputs.label }}
          RELEASE_URL: ${{ steps.release.outputs.url }}
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
          PREV_TAG: ${{ steps.prev_release.outputs.tag }}
        run: |
          LABELED_PRS=""

          # Get merge commits between tags
          if [[ -n "${PREV_TAG}" ]]; then
            echo "Finding PRs merged between ${PREV_TAG} and ${RELEASE_TAG}"
            # Get commits between tags with explicit error handling
            if ! COMMITS=$(gh api repos/${{ github.repository }}/compare/${PREV_TAG}...${RELEASE_TAG} \
              --jq '.commits[].sha' 2>&1); then
              echo "::warning::Failed to fetch commits between ${PREV_TAG} and ${RELEASE_TAG}: ${COMMITS}"
              COMMITS=""
            fi
          else
            echo "No previous release found"
            COMMITS=""
          fi

          # Find merged PRs
          if [[ -n "${COMMITS}" ]]; then
            # Search for PRs by merge commit
            for sha in ${COMMITS}; do
              PR_NUM=$(gh api repos/${{ github.repository }}/commits/${sha}/pulls \
                --jq '.[0].number // empty' 2>/dev/null || echo "")
              if [[ -n "${PR_NUM}" ]]; then
                echo "Found PR #${PR_NUM} for commit ${sha:0:7}"
                LABELED_PRS="${LABELED_PRS} ${PR_NUM}"
                # Add label
                gh pr edit ${PR_NUM} --repo ${{ github.repository }} \
                  --add-label "${LABEL_NAME}" 2>/dev/null || true
                # Add comment (skip if already commented)
                EXISTING=$(gh pr view ${PR_NUM} --repo ${{ github.repository }} \
                  --json comments --jq ".comments[].body | select(contains(\"${RELEASE_TAG}\"))" 2>/dev/null || echo "")
                if [[ -z "${EXISTING}" ]]; then
                  gh pr comment ${PR_NUM} --repo ${{ github.repository }} \
                    --body "Released in [${RELEASE_TAG}](${RELEASE_URL})" 2>/dev/null || true
                fi
              fi
            done
          else
            # Fallback for first release: find PRs merged to default branch
            # Only label PRs that don't already have a released: label
            echo "Using fallback: searching recently merged PRs without release labels"
            PR_LIST=$(gh pr list --repo ${{ github.repository }} --state merged --limit 50 \
              --json number,labels --jq '.[] | select(.labels | map(.name) | any(startswith("released:")) | not) | .number')
            for PR_NUM in ${PR_LIST}; do
              echo "Labeling PR #${PR_NUM} (first release)"
              LABELED_PRS="${LABELED_PRS} ${PR_NUM}"
              gh pr edit ${PR_NUM} --repo ${{ github.repository }} \
                --add-label "${LABEL_NAME}" 2>/dev/null || true
            done
          fi

          # Output labeled PRs for next step (avoid race condition with label query)
          echo "labeled_prs=${LABELED_PRS}" >> $GITHUB_OUTPUT

      - name: Find and label closed issues
        env:
          GH_TOKEN: ${{ github.token }}
          LABEL_NAME: ${{ steps.release.outputs.label }}
          RELEASE_URL: ${{ steps.release.outputs.url }}
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
          LABELED_PRS: ${{ steps.label_prs.outputs.labeled_prs }}
        run: |
          # Use PR numbers from previous step (avoids race condition with label propagation)
          for PR_NUM in ${LABELED_PRS}; do
            # Get issues linked/closed by this PR
            LINKED_ISSUES=$(gh pr view ${PR_NUM} --repo ${{ github.repository }} \
              --json closingIssuesReferences --jq '.closingIssuesReferences[].number' 2>/dev/null || echo "")

            for ISSUE_NUM in ${LINKED_ISSUES}; do
              echo "Labeling issue #${ISSUE_NUM} (closed by PR #${PR_NUM})"
              gh issue edit ${ISSUE_NUM} --repo ${{ github.repository }} \
                --add-label "${LABEL_NAME}" 2>/dev/null || true
              # Add comment
              EXISTING=$(gh issue view ${ISSUE_NUM} --repo ${{ github.repository }} \
                --json comments --jq ".comments[].body | select(contains(\"${RELEASE_TAG}\"))" 2>/dev/null || echo "")
              if [[ -z "${EXISTING}" ]]; then
                gh issue comment ${ISSUE_NUM} --repo ${{ github.repository }} \
                  --body "Fixed in [${RELEASE_TAG}](${RELEASE_URL})" 2>/dev/null || true
              fi
            done
          done

      - name: Summary
        env:
          GH_TOKEN: ${{ github.token }}
          LABEL_NAME: ${{ steps.release.outputs.label }}
        run: |
          PR_COUNT=$(gh pr list --repo ${{ github.repository }} --state merged \
            --label "${LABEL_NAME}" --json number --jq 'length')
          ISSUE_COUNT=$(gh issue list --repo ${{ github.repository }} --state closed \
            --label "${LABEL_NAME}" --json number --jq 'length')
          # Properly URL-encode the query parameter
          QUERY="label:${LABEL_NAME}"
          ENCODED_QUERY=$(printf '%s' "${QUERY}" | jq -sRr @uri)
          echo "## Release Labeling Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Label:** \`${LABEL_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **PRs labeled:** ${PR_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "- **Issues labeled:** ${ISSUE_COUNT}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View all labeled items](https://github.com/${{ github.repository }}/issues?q=${ENCODED_QUERY})" >> $GITHUB_STEP_SUMMARY
