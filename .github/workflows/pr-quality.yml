name: PR Quality Gates

on:
    pull_request:
        branches: [main]
        types: [opened, synchronize, reopened, ready_for_review]
    pull_request_review:
        types: [submitted]

permissions:
    contents: read
    pull-requests: write

jobs:
    quality-gate:
        name: Quality Gate
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request' && github.event.pull_request.draft == false

        steps:
            -   name: Harden Runner
                uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
                with:
                    egress-policy: audit

            -   name: Checkout
                uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

            -   name: PR Size Check
                uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
                with:
                    script: |
                        const { data: files } = await github.rest.pulls.listFiles({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: context.issue.number,
                        });
                        const total = files.reduce((sum, f) => sum + f.additions + f.deletions, 0);
                        console.log(`PR Size: ${total} lines changed`);
                        if (total > 1000) {
                          core.warning(`Large PR with ${total} changes. Consider breaking into smaller PRs.`);
                        }

    auto-approve:
        name: Auto-Approve (Solo Maintainer)
        runs-on: ubuntu-latest
        # Runs independently on both PR and review triggers
        # Only auto-approve non-draft PRs from the same repo (not forks)
        if: |
            github.event.pull_request.draft == false &&
            github.event.pull_request.head.repo.full_name == github.repository

        steps:
            -   name: Harden Runner
                uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
                with:
                    egress-policy: audit

            -   name: Check review status
                id: check-reviewers
                uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
                with:
                    script: |
                        const prNumber = context.payload.pull_request.number;

                        // Only block on explicit "Changes Requested" from human reviewers.
                        // Auto-assigned reviewers (Copilot bot, teams from CODEOWNERS/rulesets)
                        // stay in requested_reviewers perpetually — don't wait for them.
                        const { data: reviews } = await github.rest.pulls.listReviews({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: prNumber,
                        });
                        const latestByReviewer = new Map();
                        for (const review of reviews) {
                          if (review.state === 'APPROVED' || review.state === 'CHANGES_REQUESTED') {
                            latestByReviewer.set(review.user.login, review.state);
                          }
                        }
                        const changesRequested = [...latestByReviewer.entries()]
                          .filter(([login, state]) => state === 'CHANGES_REQUESTED' && !login.includes('[bot]'))
                          .map(([login]) => login);

                        if (changesRequested.length > 0) {
                          console.log(`Changes requested by: ${changesRequested.join(', ')}`);
                          core.setOutput('ready', 'false');
                        } else {
                          console.log('No human reviewer has requested changes — ready to approve');
                          core.setOutput('ready', 'true');
                        }

            -   name: Auto-approve PR
                if: steps.check-reviewers.outputs.ready == 'true'
                uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
                with:
                    script: |
                        const prNumber = context.payload.pull_request.number;

                        // Don't double-approve
                        const { data: reviews } = await github.rest.pulls.listReviews({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: prNumber,
                        });
                        const alreadyApproved = reviews.some(
                          r => r.user.login === 'github-actions[bot]' && r.state === 'APPROVED'
                        );
                        if (alreadyApproved) {
                          console.log('Already approved by automation, skipping');
                          return;
                        }

                        await github.rest.pulls.createReview({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: prNumber,
                          event: 'APPROVE',
                          body: '**Automated approval for solo maintainer project**\n\nAll assigned reviewers have completed their reviews. See SECURITY.md for compensating controls.'
                        });
