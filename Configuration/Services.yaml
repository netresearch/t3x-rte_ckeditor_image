services:
  _defaults:
    autowire: true
    autoconfigure: true
    public: false

  Netresearch\RteCKEditorImage\:
    resource: '../Classes/*'

  # Explicitly configure controllers with dependencies
  Netresearch\RteCKEditorImage\Controller\SelectImageController:
    public: true
    tags: ['backend.controller']
    arguments:
      $resourceFactory: '@TYPO3\CMS\Core\Resource\ResourceFactory'
      $uploadFolderResolver: '@TYPO3\CMS\Core\Resource\DefaultUploadFolderResolver'
      $elementBrowserRegistry: '@TYPO3\CMS\Backend\ElementBrowser\ElementBrowserRegistry'

  # TypoScript adapter for frontend image rendering
  # Bridges TypoScript preUserFunc to modern service architecture
  Netresearch\RteCKEditorImage\Controller\ImageRenderingAdapter:
    public: true
    arguments:
      $resolverService: '@Netresearch\RteCKEditorImage\Service\ImageResolverService'
      $renderingService: '@Netresearch\RteCKEditorImage\Service\ImageRenderingService'
      $attributeParser: '@Netresearch\RteCKEditorImage\Service\ImageAttributeParser'

  # Service architecture for frontend image rendering
  # These services implement the modern TYPO3 v13 ViewFactoryInterface pattern
  # Services are public to allow testing framework access via $this->get()
  Netresearch\RteCKEditorImage\Service\ImageAttributeParser:
    public: true
    # Pure HTML parsing - no dependencies needed

  Netresearch\RteCKEditorImage\Service\ImageResolverService:
    public: true
    arguments:
      $resourceFactory: '@TYPO3\CMS\Core\Resource\ResourceFactory'
      $processedFilesHandler: '@Netresearch\RteCKEditorImage\Utils\ProcessedFilesHandler'
      $svgSanitizer: '@TYPO3\CMS\Core\Resource\Security\SvgSanitizer'
      $logManager: '@TYPO3\CMS\Core\Log\LogManager'

  Netresearch\RteCKEditorImage\Service\ImageRenderingService:
    public: true
    arguments:
      $viewFactory: '@TYPO3\CMS\Core\View\ViewFactoryInterface'

  # Utility classes with dependencies
  Netresearch\RteCKEditorImage\Utils\ProcessedFilesHandler:
    arguments:
      $imageService: '@TYPO3\CMS\Extbase\Service\ImageService'

  Netresearch\RteCKEditorImage\DataHandling\SoftReference\RteImageSoftReferenceParser:
    public: true
    tags:
      - name: softreference.parser
        parserKey: rtehtmlarea_images

  # DataHandler hook with full dependency injection
  Netresearch\RteCKEditorImage\Database\RteImagesDbHook:
    public: true
    arguments:
      $extensionConfiguration: '@TYPO3\CMS\Core\Configuration\ExtensionConfiguration'
      $logManager: '@TYPO3\CMS\Core\Log\LogManager'
      $resourceFactory: '@TYPO3\CMS\Core\Resource\ResourceFactory'
      $context: '@TYPO3\CMS\Core\Context\Context'
      $requestFactory: '@TYPO3\CMS\Core\Http\RequestFactory'
      $uploadFolderResolver: '@TYPO3\CMS\Core\Resource\DefaultUploadFolderResolver'

  # Event listener for automatic RTE softref enforcement
  Netresearch\RteCKEditorImage\Listener\TCA\RteSoftrefEnforcer:
    arguments:
      $extensionConfiguration: '@TYPO3\CMS\Core\Configuration\ExtensionConfiguration'
    tags:
      - name: event.listener
        identifier: 'nr-rte-softref-enforcer'
        event: TYPO3\CMS\Core\Configuration\Event\AfterTcaCompilationEvent
        after: '*'

